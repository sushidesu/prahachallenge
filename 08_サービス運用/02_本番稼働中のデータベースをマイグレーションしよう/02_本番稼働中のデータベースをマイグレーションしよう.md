# 本番稼働中のデータベースをマイグレーションしよう

## 課題1 (質問)

### expand and contract pattern

#### 説明

新しいスキーマと古いスキーマを共存させ、徐々に新しいスキーマに切り替えていくやり方。

#### 手順

1. 新しいスキーマをデプロイ
2. 書き込みは新旧両方のスキーマに対して行う (読み取りは旧スキーマのまま)
3. 古いデータを新しいスキーマにコピーする
4. 新しいスキーマをテストする
5. 読み取り先も新しいスキーマにする
6. 古いスキーマへの書き込みを止める
7. 古いスキーマを削除する

#### 参考

https://www.prisma.io/dataguide/types/relational/expand-and-contract-pattern

### NOT NULL制約の追加

#### 失敗の理由

NOT NULL制約を追加しようとしているカラムにNULLの値が入っているレコードがあるから

#### 対策

1. NOT NULL制約の追加とともにデフォルト値を設定する (その後不要であればデフォルト値の設定を外す)
2. NULLのレコードに値を設定してからNOT NULL制約を追加する

#### 参考

https://blog.kozakana.net/2019/09/add_column_which_sets_not_null_constraint_and_not_default/

## 課題2 (実装)

マイグレーションの作業手順書の作成: [マイグレーション手順書_ユーザーが複数ペア所属.md](./マイグレーション手順書_ユーザー複数ペア所属.md)

#### どのような情報を手順書に残しておくと良いか？

- 手順書の作成者
  - 問題があった時に聞けるように
- 手順書を実行する時刻、実行にかかる時間の予想
  - サービス稼働中に行うのか、ユーザーが少ない時刻に行うのかを検討する
- マイグレーションを行う背景
- このコマンドを実行する理由
